{% extends "dash/dash-base.html" %}

{% load static %}
{% block title %}View Document{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/popup.css' %}">
<style>
  .detail-row { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb; }
  .detail-label { font-weight: bold; color: #4b5563; }
  .detail-value { color: #1f2937; }
  .media-container { max-height: 500px; overflow: auto; margin: 1rem 0; }
  audio, embed { width: 100%; max-width: 100%; }
</style>

<!-- View Document Section -->
<section class="py-16 px-4 md:px-16 max-w-2xl mx-auto text-center">
  <h2 class="text-3xl font-bold mb-8">Document Details</h2>
  <div class="bg-white p-6 rounded-lg glow">
    <h3 class="text-xl font-semibold mb-4">{{ document.title }}</h3>
    <div class="space-y-2 text-left">
      <div class="detail-row">
        <span class="detail-label">Document ID:</span>
        <span class="detail-value">DOC-{{ document.id }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Title:</span>
        <span class="detail-value">{{ document.title }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Type:</span>
        <span class="detail-value">{{ document.file_type|capfirst }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Uploaded By:</span>
        <span class="detail-value">{{ document.user.full_name }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Upload Date:</span>
        <span class="detail-value">{{ document.upload_date|date:"Y-m-d" }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Status:</span>
        <span class="detail-value">{{ document.status|capfirst }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Description:</span>
        <span class="detail-value">{{ document.description|default:"No description provided" }}</span>
      </div>
    </div>

    <!-- Media Display -->
    <div class="media-container mt-6">
      {% if document.file_type == 'audio' %}
      <audio controls>
        <source src="{{ document.file.url }}" type="{{ document.file_type.mime_type|default:'audio/mpeg' }}">
        Your browser does not support the audio element.
      </audio>
      {% elif document.file_type == 'pdf' %}
      <iframe src="{{ document.file.url }}#toolbar=0" type="application/pdf" width="100%" height="500px"></iframe>
      <p class="text-gray-600 mt-2">
        <a href="{{ document.file.url }}" class="text-blue-600 hover:underline" target="_blank">Download PDF</a>
      </p>
      {% endif %}
    </div>

    {% if current_user.role == 'admin' %}
    <!-- Actions -->
    <div class="mt-6 flex justify-center space-x-4">
      {% if document.status == 'pending' %}
      <form method="POST" id="upload_update">
        {% csrf_token %}
        <input type="hidden" id="id" value="{{document.id}}">
        <button class="p-3 bg-green-600 text-white rounded-lg hover:bg-green-700 glow">
          Approve
        </button>
      </form>
      {% endif %}
    </div>
    {% endif %}
    <p class="mt-4 text-sm text-gray-600">
      <a href="/manage-documents/" class="hover:text-blue-600">Back to Manage Documents</a>
    </p>
  </div>
</section>

<!-- Popup Modal -->
<div id="popupModal" class="modal flex">
  <div id="modalContent" class="modal-content glow">
    <span class="modal-close" onclick="hidePopup()">&times;</span>
    <h3 id="popupTitle" class="text-2xl font-bold mb-4">Success!</h3>
    <p id="popupMessage" class="text-gray-600 mb-6">Your action was successful.</p>
    <a id="popupAction" href="/" class="p-3 text-white rounded-lg glow">OK</a>
  </div>
</div>

<script>
  // Popup Functions
  function showPopup(type, title, message, actionUrl, actionText) {
    const modalContent = document.getElementById('modalContent');
    const actionButton = document.getElementById('popupAction');
    document.getElementById('popupTitle').textContent = title;
    document.getElementById('popupMessage').textContent = message;
    actionButton.href = actionUrl;
    actionButton.textContent = actionText;
    modalContent.classList.remove('modal-success', 'modal-error');
    actionButton.classList.remove('btn-success', 'btn-error');
    if (type === 'success') {
      modalContent.classList.add('modal-success');
      actionButton.classList.add('btn-success');
    } else if (type === 'error') {
      modalContent.classList.add('modal-error');
      actionButton.classList.add('btn-error');
    }
    document.getElementById('popupModal').style.display = 'flex';
  }

  function hidePopup() {
    document.getElementById('popupModal').style.display = 'none';
  }

  document.getElementById('popupModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('popupModal')) {
      hidePopup();
    }
  });
</script>

<script>
    $(document).on('submit', '#upload_update', function (e){
        e.preventDefault();
        var formData = new FormData(this);
        var id = $('#id').val();
        $.ajax({
            type: 'POST',
            url: '/update-document-status/'+id, 
            data: formData,
            processData: false,
            contentType: false,
            success: function (response){
                var success = response['success'];
                if(success){
                    showPopup('success', 'Success!', response['message'], '/view-documents/'+id, 'Okay')
                }else{
                    showPopup('error', 'Error!', response['message'], '#', 'Again!')
                }
            }
        });
    });
  </script>
{% endblock %}